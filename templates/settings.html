{% extends "base.html" %}

{% block title %}Settings - Personal Finance Tracker{% endblock %}

{% block content %}

<!-- Page Header -->
<div style="padding: 32px 0 24px 0;">
    <h1 style="font-size: 32px; font-weight: 400; margin: 0; color: var(--md-on-surface); display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-cog"></i>
        Settings
    </h1>
    <p style="color: var(--md-on-surface-variant); margin: 8px 0 0 0;">Manage your account and preferences</p>
</div>

<div class="md-grid md-grid-cols-2">
    <!-- User Profile -->
    <div class="md-card" style="margin-bottom: 24px;">
        <div class="md-card-header">
            <h5 class="md-card-title"><i class="fas fa-user" style="margin-right: 8px;"></i>User Profile</h5>
        </div>
        <div class="md-card-body">
            <form id="profileForm">
                <div class="md-text-field">
                    <input type="text" id="username" value="{{ user.username }}" readonly disabled style="opacity: 0.6;">
                    <label for="username">Username</label>
                </div>

                <div class="md-text-field">
                    <input type="email" id="email" name="email" value="{{ user.email }}" placeholder=" ">
                    <label for="email">Email</label>
                </div>

                <div class="md-text-field">
                    <select id="currency" name="default_currency" onchange="showCurrencyWarning()">
                        {% for currency_code in currencies %}
                        <option value="{{ currency_code }}" {% if user.default_currency == currency_code %}selected{% endif %}>
                            {{ currency_code }} - {{ currency_names[currency_code] }}
                        </option>
                        {% endfor %}
                    </select>
                    <label for="currency">Default Currency</label>
                </div>

                <!-- Currency Change Warning -->
                <div id="currencyWarning" style="display: none; margin-top: 8px; padding: 12px; background: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--md-warning); border-radius: 4px;">
                    <p style="margin: 0 0 8px 0; font-size: 13px; color: var(--md-on-surface);">
                        <i class="fas fa-exclamation-triangle" style="color: var(--md-warning);"></i>
                        <strong>Important - Currency Display Only:</strong>
                    </p>
                    <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--md-on-surface-variant); line-height: 1.6;">
                        <li>Changes how amounts are <em>displayed</em>, NOT their actual value</li>
                        <li>Existing values will NOT be converted (e.g., $100 → €100, not €92)</li>
                        <li>Exchange rates shown are approximate and may be inaccurate</li>
                        <li>For accurate conversions, consult your bank or financial institution</li>
                    </ul>
                </div>

                <div class="md-text-field">
                    <input type="number" id="monthly_income" name="monthly_income" value="{{ user.monthly_income or 0 }}" step="0.01" placeholder=" ">
                    <label for="monthly_income">Monthly Income</label>
                </div>

                <button type="button" class="md-btn md-btn-filled" style="width: 100%; justify-content: center;" onclick="updateProfile()">
                    Update Profile
                </button>
            </form>
        </div>
    </div>

    <!-- Budget Categories Summary -->
    <div class="md-card" style="margin-bottom: 24px;">
        <div class="md-card-header">
            <h5 class="md-card-title"><i class="fas fa-tags" style="margin-right: 8px;"></i>Budget Categories</h5>
        </div>
        <div class="md-card-body" style="padding: 0;">
            <ul class="md-list">
                <li class="md-list-item">
                    <div class="md-list-item-icon" style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(67, 160, 71, 0.12); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-plus-circle" style="color: var(--md-success);"></i>
                    </div>
                    <div class="md-list-item-text">
                        <div class="md-list-item-primary">Income Categories</div>
                        <div class="md-list-item-secondary">Sources of income</div>
                    </div>
                    <span class="md-chip md-chip-success">{{ user.budget_categories|selectattr('category_type', 'equalto', 'income')|list|length }}</span>
                </li>
                <div class="md-divider" style="margin: 0;"></div>
                <li class="md-list-item">
                    <div class="md-list-item-icon" style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(229, 57, 53, 0.12); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-minus-circle" style="color: var(--md-error);"></i>
                    </div>
                    <div class="md-list-item-text">
                        <div class="md-list-item-primary">Expense Categories</div>
                        <div class="md-list-item-secondary">Where money is spent</div>
                    </div>
                    <span class="md-chip md-chip-error">{{ user.budget_categories|selectattr('category_type', 'equalto', 'expense')|list|length }}</span>
                </li>
                <div class="md-divider" style="margin: 0;"></div>
                <li class="md-list-item">
                    <div class="md-list-item-icon" style="width: 40px; height: 40px; border-radius: 50%; background-color: rgba(30, 136, 229, 0.12); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-piggy-bank" style="color: var(--md-primary);"></i>
                    </div>
                    <div class="md-list-item-text">
                        <div class="md-list-item-primary">Savings Categories</div>
                        <div class="md-list-item-secondary">Financial goals</div>
                    </div>
                    <span class="md-chip md-chip-primary">{{ user.budget_categories|selectattr('category_type', 'equalto', 'saving')|list|length }}</span>
                </li>
            </ul>
            <div style="padding: 16px 24px; text-align: center; border-top: 1px solid var(--md-surface-container-high);">
                <a href="{{ url_for('main.budget') }}" class="md-btn md-btn-text">
                    Manage Categories
                    <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Data Management -->
    <div class="md-card" style="margin-bottom: 24px;">
        <div class="md-card-header">
            <h5 class="md-card-title"><i class="fas fa-database" style="margin-right: 8px;"></i>Data Management</h5>
        </div>
        <div class="md-card-body">
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="md-btn md-btn-outlined" style="width: 100%; justify-content: flex-start;" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    Export All Data
                </button>
                <button class="md-btn md-btn-outlined" style="width: 100%; justify-content: flex-start;" onclick="backupData()">
                    <i class="fas fa-save"></i>
                    Create Backup
                </button>
                <button class="md-btn md-btn-outlined" style="width: 100%; justify-content: flex-start;" onclick="importData()">
                    <i class="fas fa-upload"></i>
                    Import Data
                </button>
                <div class="md-divider"></div>
                <button class="md-btn md-btn-text" style="width: 100%; justify-content: flex-start; color: var(--md-error);" onclick="clearData()">
                    <i class="fas fa-trash"></i>
                    Clear All Data
                </button>
            </div>
        </div>
    </div>

    <!-- Account Security -->
    <div class="md-card" style="margin-bottom: 24px;">
        <div class="md-card-header">
            <h5 class="md-card-title"><i class="fas fa-shield-alt" style="margin-right: 8px;"></i>Account Security</h5>
        </div>
        <div class="md-card-body">
            <form id="passwordForm">
                <div class="md-text-field">
                    <input type="password" id="current_password" name="current_password" placeholder=" ">
                    <label for="current_password">Current Password</label>
                </div>

                <div class="md-text-field">
                    <input type="password" id="new_password" name="new_password" placeholder=" ">
                    <label for="new_password">New Password</label>
                </div>

                <div class="md-text-field">
                    <input type="password" id="confirm_password" name="confirm_password" placeholder=" ">
                    <label for="confirm_password">Confirm New Password</label>
                </div>

                <button type="button" class="md-btn md-btn-filled" style="width: 100%; justify-content: center; background-color: var(--md-warning);" onclick="changePassword()">
                    <i class="fas fa-key"></i>
                    Change Password
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Application Info -->
<div class="md-card">
    <div class="md-card-header">
        <h5 class="md-card-title"><i class="fas fa-info-circle" style="margin-right: 8px;"></i>Application Information</h5>
    </div>
    <div class="md-card-body">
        <div class="md-grid md-grid-cols-2">
            <div>
                <p style="margin: 0 0 12px 0;"><strong>Account Created:</strong> {{ user.created_at.strftime('%B %d, %Y') }}</p>
                <p style="margin: 0 0 12px 0;"><strong>Total Categories:</strong> {{ user.budget_categories|length }}</p>
                <p style="margin: 0;"><strong>Total Transactions:</strong> {{ user.transactions|length }}</p>
            </div>
            <div>
                <p style="margin: 0 0 12px 0;"><strong>Version:</strong> 2.0.0</p>
                <p style="margin: 0 0 12px 0;"><strong>Default Currency:</strong> {{ user.default_currency or 'KES' }}</p>
                <p style="margin: 0;"><strong>Data Security:</strong> Encrypted & Backed Up</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Store original currency to detect changes
let originalCurrency = document.getElementById('currency').value;

function showCurrencyWarning() {
    const currentCurrency = document.getElementById('currency').value;
    const warningDiv = document.getElementById('currencyWarning');

    // Show warning only if currency was actually changed from original
    if (currentCurrency !== originalCurrency) {
        warningDiv.style.display = 'block';
    } else {
        warningDiv.style.display = 'none';
    }
}

async function updateProfile() {
    const email = document.getElementById('email').value;
    const monthlyIncome = document.getElementById('monthly_income').value;
    const currency = document.getElementById('currency').value;

    // Confirm currency change if different from original
    if (currency !== originalCurrency) {
        const confirmed = confirm(
            '⚠️ Currency Change Confirmation\n\n' +
            `You are changing your display currency from ${originalCurrency} to ${currency}.\n\n` +
            'IMPORTANT: This will NOT convert your existing amounts. ' +
            'It only changes the currency symbol displayed.\n\n' +
            'For example:\n' +
            `• $100 USD will display as ${currency} 100 (not converted)\n` +
            `• Your budget allocations will show ${currency} symbols\n\n` +
            'Continue with this change?'
        );

        if (!confirmed) {
            // Reset to original currency
            document.getElementById('currency').value = originalCurrency;
            showCurrencyWarning();
            return;
        }
    }

    try {
        const response = await fetch('/auth/api/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                monthly_income: monthlyIncome,
                default_currency: currency
            })
        });

        const data = await response.json();

        if (response.ok) {
            showMaterialSnackbar(data.message, 'success');
            // Update original currency after successful save
            originalCurrency = currency;
            // Hide warning after successful save
            document.getElementById('currencyWarning').style.display = 'none';
        } else {
            if (data.errors) {
                data.errors.forEach(err => showMaterialSnackbar(err, 'error'));
            } else {
                showMaterialSnackbar(data.error || 'Failed to update profile', 'error');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Failed to update profile', 'error');
    }
}

async function changePassword() {
    const current = document.getElementById('current_password').value;
    const newPass = document.getElementById('new_password').value;
    const confirm = document.getElementById('confirm_password').value;

    if (!current || !newPass || !confirm) {
        showMaterialSnackbar('Please fill in all password fields', 'error');
        return;
    }

    if (newPass !== confirm) {
        showMaterialSnackbar('New passwords do not match', 'error');
        return;
    }

    try {
        const response = await fetch('/auth/api/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: current,
                new_password: newPass,
                confirm_password: confirm
            })
        });

        const data = await response.json();

        if (response.ok) {
            showMaterialSnackbar(data.message, 'success');
            // Clear password fields
            document.getElementById('current_password').value = '';
            document.getElementById('new_password').value = '';
            document.getElementById('confirm_password').value = '';
        } else {
            if (data.errors) {
                data.errors.forEach(err => showMaterialSnackbar(err, 'error'));
            } else {
                showMaterialSnackbar(data.error || 'Failed to change password', 'error');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Failed to change password', 'error');
    }
}

async function exportData() {
    try {
        showMaterialSnackbar('Preparing data export...', 'info');

        const response = await fetch('/auth/api/export-data');

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Get filename from response headers or use default
            const disposition = response.headers.get('Content-Disposition');
            let filename = 'export_data.json';
            if (disposition && disposition.includes('filename=')) {
                filename = disposition.split('filename=')[1].replace(/"/g, '');
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            showMaterialSnackbar('Data exported successfully!', 'success');
        } else {
            const data = await response.json();
            showMaterialSnackbar(data.error || 'Failed to export data', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Failed to export data', 'error');
    }
}

async function backupData() {
    try {
        showMaterialSnackbar('Creating backup...', 'info');

        const response = await fetch('/auth/api/backup-data');

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Get filename from response headers or use default
            const disposition = response.headers.get('Content-Disposition');
            let filename = 'backup.json';
            if (disposition && disposition.includes('filename=')) {
                filename = disposition.split('filename=')[1].replace(/"/g, '');
            }

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();

            showMaterialSnackbar('Backup created successfully!', 'success');
        } else {
            const data = await response.json();
            showMaterialSnackbar(data.error || 'Failed to create backup', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Failed to create backup', 'error');
    }
}

function importData() {
    // Create file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            const formData = new FormData();
            formData.append('file', file);

            showMaterialSnackbar('Importing data...', 'info');

            // Note: Import endpoint needs to be implemented on backend
            showMaterialSnackbar('Import functionality coming soon! Use backup restore for now.', 'warning');

            // TODO: Implement import endpoint
            // const response = await fetch('/auth/api/import-data', {
            //     method: 'POST',
            //     body: formData
            // });
        } catch (error) {
            console.error('Error:', error);
            showMaterialSnackbar('Failed to import data', 'error');
        }
    };

    input.click();
}

async function clearData() {
    // Create custom Material Design confirmation dialog
    const confirmed = confirm('⚠️ WARNING: This will permanently delete ALL your data!\n\nThis includes:\n• All transactions\n• All budget categories\n• All milestones\n\nThis action CANNOT be undone!\n\nType "DELETE ALL DATA" in the next prompt to confirm.');

    if (!confirmed) return;

    const confirmation = prompt('Type "DELETE ALL DATA" to confirm (case sensitive):');

    if (confirmation !== 'DELETE ALL DATA') {
        showMaterialSnackbar('Data clear cancelled - confirmation text did not match', 'info');
        return;
    }

    try {
        const response = await fetch('/auth/api/clear-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                confirmation: confirmation
            })
        });

        const data = await response.json();

        if (response.ok) {
            showMaterialSnackbar(data.message, 'success');
            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMaterialSnackbar(data.error || 'Failed to clear data', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Failed to clear data', 'error');
    }
}

function showMaterialSnackbar(message, type = 'info') {
    const snackbar = document.createElement('div');
    snackbar.className = 'md-snackbar show';

    const colors = {
        'success': 'var(--md-success)',
        'error': 'var(--md-error)',
        'warning': 'var(--md-warning)',
        'info': 'var(--md-info)'
    };
    snackbar.style.backgroundColor = colors[type] || colors.info;

    snackbar.innerHTML = `
        <span>${message}</span>
        <button class="md-btn md-btn-text" style="color: white; padding: 8px 16px;" onclick="this.parentElement.remove()">
            Dismiss
        </button>
    `;

    document.body.appendChild(snackbar);

    setTimeout(() => {
        snackbar.style.opacity = '0';
        setTimeout(() => snackbar.parentNode && snackbar.remove(), 300);
    }, 5000);
}
</script>
{% endblock %}
