{% extends "base.html" %}

{% block title %}Reports - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line me-2"></i>Financial Reports</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="exportReports()">
            <i class="fas fa-download me-2"></i>Export
        </button>
    </div>
</div>

<!-- Date Range Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary d-block w-100">Update Report</button>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6>Total Income</h6>
                <h3>{{ format_currency(summary.total_income) }}</h3>
                <small>{{ date_range }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h6>Total Expenses</h6>
                <h3>{{ format_currency(summary.total_expenses) }}</h3>
                <small>{{ date_range }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h6>Net Amount</h6>
                <h3>{{ format_currency(summary.net_amount) }}</h3>
                <small>{{ date_range }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h6>Transaction Count</h6>
                <h3>{{ summary.transaction_count }}</h3>
                <small>Total transactions</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Category Spending Chart -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Spending by Category</h5>
            </div>
            <div class="card-body">
                <canvas id="categorySpendingChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Monthly Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyTrendChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Category Breakdown Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Category Breakdown</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Amount Spent</th>
                        <th>Percentage</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% if category_spending %}
                        {% for category, amount in category_spending.items() %}
                        {% set percentage = (amount / summary.total_expenses * 100) if summary.total_expenses > 0 else 0 %}
                        <tr>
                            <td>{{ category }}</td>
                            <td class="text-danger">{{ format_currency(amount) }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                        <div class="progress-bar bg-danger" style="width: {{ percentage }}%"></div>
                                    </div>
                                    <small>{{ "%.1f"|format(percentage) }}%</small>
                                </div>
                            </td>
                            <td>
                                <i class="fas fa-minus text-muted"></i>
                                <small class="text-muted">No trend data</small>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                No expense data available for the selected period.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Category Spending Chart
const categoryLabels = {{ category_spending.keys()|list|tojson if category_spending else '[]'|safe }};
const categoryData = {{ category_spending.values()|list|map('float')|list|tojson if category_spending else '[]'|safe }};

if (categoryLabels.length > 0) {
    const ctx1 = document.getElementById('categorySpendingChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
} else {
    document.getElementById('categorySpendingChart').innerHTML = '<p class="text-center text-muted mt-5">No data available</p>';
}

// Monthly Trend Chart
const monthlyData = {{ monthly_data|tojson if monthly_data else '[]'|safe }};

if (monthlyData.length > 0) {
    const ctx2 = document.getElementById('monthlyTrendChart').getContext('2d');
    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: monthlyData.map(d => d.month),
            datasets: [
                {
                    label: 'Income',
                    data: monthlyData.map(d => d.income),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Expenses',
                    data: monthlyData.map(d => d.expenses),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Net',
                    data: monthlyData.map(d => d.net),
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
} else {
    document.getElementById('monthlyTrendChart').innerHTML = '<p class="text-center text-muted mt-5">No data available</p>';
}

function exportReports() {
    alert('Export functionality coming soon!');
}
</script>
{% endblock %}