{% extends "base.html" %}

{% block title %}Reports - Personal Finance Tracker{% endblock %}

{% block content %}

<!-- Page Header -->
<div style="display: flex; justify-content: space-between; align-items: center; padding: 32px 0 24px 0;">
    <h1 style="font-size: 32px; font-weight: 400; margin: 0; color: var(--md-on-surface); display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-chart-line"></i>
        Financial Reports
    </h1>
    <button class="md-btn md-btn-outlined" onclick="exportReports()">
        <i class="fas fa-download"></i>
        Export
    </button>
</div>

<!-- Date Range Filter -->
<div class="md-card" style="margin-bottom: 24px;">
    <div class="md-card-body">
        <form method="GET" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="md-text-field">
                <input type="date" name="start_date" id="startDate" value="{{ start_date }}" required>
                <label for="startDate">Start Date</label>
            </div>

            <div class="md-text-field">
                <input type="date" name="end_date" id="endDate" value="{{ end_date }}" required>
                <label for="endDate">End Date</label>
            </div>

            <button type="submit" class="md-btn md-btn-filled" style="height: 48px;">
                Update Report
            </button>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="md-grid md-grid-cols-4" style="margin-bottom: 24px;">
    <div class="md-card" style="background: linear-gradient(135deg, var(--md-success) 0%, #2E7D32 100%); color: white;">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; opacity: 0.9; font-weight: 400;">Total Income</h6>
            <div style="font-size: 28px; font-weight: 400; margin-bottom: 4px;">{{ format_currency(summary.total_income) }}</div>
            <small style="opacity: 0.8;">{{ date_range }}</small>
        </div>
    </div>

    <div class="md-card" style="background: linear-gradient(135deg, var(--md-error) 0%, #C62828 100%); color: white;">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; opacity: 0.9; font-weight: 400;">Total Expenses</h6>
            <div style="font-size: 28px; font-weight: 400; margin-bottom: 4px;">{{ format_currency(summary.total_expenses) }}</div>
            <small style="opacity: 0.8;">{{ date_range }}</small>
        </div>
    </div>

    <div class="md-card md-card-elevated">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; color: var(--md-on-surface-variant); font-weight: 400;">Net Amount</h6>
            <div style="font-size: 28px; font-weight: 500; margin-bottom: 4px; color: {% if summary.net_amount >= 0 %}var(--md-success){% else %}var(--md-error){% endif %};">{{ format_currency(summary.net_amount) }}</div>
            <small style="color: var(--md-on-surface-variant);">{{ date_range }}</small>
        </div>
    </div>

    <div class="md-card" style="background: linear-gradient(135deg, var(--md-warning) 0%, #F57C00 100%); color: white;">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; opacity: 0.9; font-weight: 400;">Transaction Count</h6>
            <div style="font-size: 28px; font-weight: 400; margin-bottom: 4px;">{{ summary.transaction_count }}</div>
            <small style="opacity: 0.8;">Total transactions</small>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="md-grid md-grid-cols-2" style="margin-bottom: 24px;">
    <!-- Category Spending Chart -->
    <div class="md-card">
        <div class="md-card-header">
            <h5 class="md-card-title">Spending by Category</h5>
        </div>
        <div class="md-card-body">
            <canvas id="categorySpendingChart" height="300"></canvas>
        </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="md-card">
        <div class="md-card-header">
            <h5 class="md-card-title">Monthly Trend</h5>
        </div>
        <div class="md-card-body">
            <canvas id="monthlyTrendChart" height="300"></canvas>
        </div>
    </div>
</div>

<!-- Category Breakdown -->
<div class="md-card">
    <div class="md-card-header">
        <h5 class="md-card-title">Category Breakdown</h5>
    </div>
    <div class="md-card-body" style="padding: 0;">
        {% if category_spending %}
            <ul class="md-list">
                {% for category, amount in category_spending.items() %}
                {% set percentage = (amount / summary.total_expenses * 100) if summary.total_expenses > 0 else 0 %}
                <li class="md-list-item">
                    <div class="md-list-item-text" style="flex: 1;">
                        <div class="md-list-item-primary" style="font-weight: 500;">{{ category }}</div>
                        <div class="md-list-item-secondary" style="margin-top: 8px;">
                            <div class="md-progress-linear" style="margin-bottom: 4px;">
                                <div class="md-progress-bar" style="width: {{ percentage }}%; background-color: var(--md-error);"></div>
                            </div>
                            <small>{{ "%.1f"|format(percentage) }}% of total expenses</small>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 18px; font-weight: 500; color: var(--md-error);">
                            {{ format_currency(amount) }}
                        </div>
                    </div>
                </li>
                <div class="md-divider" style="margin: 0;"></div>
                {% endfor %}
            </ul>
        {% else %}
            <div style="padding: 48px 24px; text-align: center;">
                <i class="fas fa-chart-pie" style="font-size: 48px; color: var(--md-on-surface-variant); opacity: 0.3; margin-bottom: 16px;"></i>
                <p style="color: var(--md-on-surface-variant); margin: 0;">No expense data available for the selected period.</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Material Design Colors
const mdChartColors = [
    '#1E88E5', '#26A69A', '#43A047', '#FB8C00',
    '#E53935', '#039BE5', '#7E57C2', '#EF5350',
    '#66BB6A', '#29B6F6'
];

// Category Spending Chart
const categoryLabels = {{ category_spending.keys()|list|tojson if category_spending else '[]'|safe }};
const categoryData = {{ category_spending.values()|list|map('float')|list|tojson if category_spending else '[]'|safe }};

if (categoryLabels.length > 0) {
    const ctx1 = document.getElementById('categorySpendingChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryData,
                backgroundColor: mdChartColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: { family: 'Roboto', size: 12 },
                        padding: 16,
                        usePointStyle: true
                    }
                }
            }
        }
    });
} else {
    document.getElementById('categorySpendingChart').parentElement.innerHTML = '<p style="text-align: center; color: var(--md-on-surface-variant); padding: 48px 0;">No data available</p>';
}

// Monthly Trend Chart
const monthlyData = {{ monthly_data|tojson if monthly_data else '[]'|safe }};

if (monthlyData.length > 0) {
    const ctx2 = document.getElementById('monthlyTrendChart').getContext('2d');
    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: monthlyData.map(d => d.month),
            datasets: [
                {
                    label: 'Income',
                    data: monthlyData.map(d => d.income),
                    borderColor: '#43A047',
                    backgroundColor: 'rgba(67, 160, 71, 0.08)',
                    tension: 0.4,
                    borderWidth: 3,
                    fill: true,
                    pointBackgroundColor: '#43A047',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4
                },
                {
                    label: 'Expenses',
                    data: monthlyData.map(d => d.expenses),
                    borderColor: '#E53935',
                    backgroundColor: 'rgba(229, 57, 53, 0.08)',
                    tension: 0.4,
                    borderWidth: 3,
                    fill: true,
                    pointBackgroundColor: '#E53935',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4
                },
                {
                    label: 'Net',
                    data: monthlyData.map(d => d.net),
                    borderColor: '#1E88E5',
                    backgroundColor: 'rgba(30, 136, 229, 0.08)',
                    tension: 0.4,
                    borderWidth: 3,
                    fill: true,
                    pointBackgroundColor: '#1E88E5',
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: {
                        font: { family: 'Roboto' },
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { family: 'Roboto' } }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: { family: 'Roboto', size: 12 },
                        padding: 16,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { family: 'Roboto' },
                    bodyFont: { family: 'Roboto' },
                    padding: 12,
                    cornerRadius: 8
                }
            }
        }
    });
} else {
    document.getElementById('monthlyTrendChart').parentElement.innerHTML = '<p style="text-align: center; color: var(--md-on-surface-variant); padding: 48px 0;">No data available</p>';
}

function exportReports() {
    const snackbar = document.createElement('div');
    snackbar.className = 'md-snackbar show';
    snackbar.style.backgroundColor = 'var(--md-info)';
    snackbar.innerHTML = '<span>Export functionality coming soon!</span><button class="md-btn md-btn-text" style="color: white; padding: 8px 16px;" onclick="this.parentElement.remove()">Dismiss</button>';
    document.body.appendChild(snackbar);
    setTimeout(() => {
        snackbar.style.opacity = '0';
        setTimeout(() => snackbar.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}