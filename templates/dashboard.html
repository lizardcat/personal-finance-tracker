{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

    <!-- Page Header -->
    <div style="padding: 32px 0 24px 0;">
        <h1 style="font-size: 32px; font-weight: 400; margin: 0; color: var(--md-on-surface);">Financial Dashboard</h1>
        <p style="color: var(--md-on-surface-variant); margin: 8px 0 0 0;">Overview of your financial health</p>
    </div>

    <!-- Summary Cards -->
    <div class="md-grid md-grid-cols-4" style="margin-bottom: 24px;">
        <!-- Available Budget Card -->
        <div class="md-card md-card-elevated" style="background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-primary-dark) 100%); color: white;">
            <div class="md-card-body">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h5 style="margin: 0; font-size: 14px; font-weight: 500; opacity: 0.9;">Available Budget</h5>
                    <i class="fas fa-wallet" style="font-size: 24px; opacity: 0.7;"></i>
                </div>
                <h2 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 400;">{{ format_currency(total_available) }}</h2>
                <small style="opacity: 0.8;">Available to budget</small>
            </div>
        </div>

        <!-- Total Income Card -->
        <div class="md-card md-card-elevated" style="background: linear-gradient(135deg, var(--md-success) 0%, #2E7D32 100%); color: white;">
            <div class="md-card-body">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h5 style="margin: 0; font-size: 14px; font-weight: 500; opacity: 0.9;">Total Income</h5>
                    <i class="fas fa-arrow-trend-up" style="font-size: 24px; opacity: 0.7;"></i>
                </div>
                <h2 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 400;">{{ format_currency(monthly_summary.total_income) }}</h2>
                <small style="opacity: 0.8;">{{ current_month }}</small>
            </div>
        </div>

        <!-- Total Expenses Card -->
        <div class="md-card md-card-elevated" style="background: linear-gradient(135deg, var(--md-warning) 0%, #F57C00 100%); color: white;">
            <div class="md-card-body">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h5 style="margin: 0; font-size: 14px; font-weight: 500; opacity: 0.9;">Total Expenses</h5>
                    <i class="fas fa-arrow-trend-down" style="font-size: 24px; opacity: 0.7;"></i>
                </div>
                <h2 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 400;">{{ format_currency(monthly_summary.total_expenses) }}</h2>
                <small style="opacity: 0.8;">{{ current_month }}</small>
            </div>
        </div>

        <!-- Net Amount Card -->
        <div class="md-card md-card-elevated" style="background: linear-gradient(135deg, var(--md-info) 0%, #0277BD 100%); color: white;">
            <div class="md-card-body">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h5 style="margin: 0; font-size: 14px; font-weight: 500; opacity: 0.9;">Net Amount</h5>
                    <i class="fas fa-chart-line" style="font-size: 24px; opacity: 0.7;"></i>
                </div>
                <h2 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 400;">{{ format_currency(monthly_summary.net_amount) }}</h2>
                <small style="opacity: 0.8;">{{ current_month }}</small>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="md-grid md-grid-cols-2" style="margin-bottom: 24px;">
        <!-- Category Chart Card -->
        <div class="md-card">
            <div class="md-card-header">
                <h5 class="md-card-title">Monthly Spending by Category</h5>
            </div>
            <div class="md-card-body">
                <canvas id="categoryChart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Trend Chart Card -->
        <div class="md-card">
            <div class="md-card-header">
                <h5 class="md-card-title">Monthly Trend</h5>
            </div>
            <div class="md-card-body">
                <canvas id="trendChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="md-card">
        <div class="md-card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h5 class="md-card-title">Recent Transactions</h5>
            <a href="/transactions" class="md-btn md-btn-outlined">View All</a>
        </div>
        <div class="md-card-body" style="padding: 0;">
            {% if recent_transactions %}
                <ul class="md-list">
                    {% for transaction in recent_transactions %}
                    <li class="md-list-item">
                        <div class="md-list-item-icon" style="width: 40px; height: 40px; border-radius: 50%; background-color: {% if transaction.transaction_type == 'income' %}rgba(67, 160, 71, 0.12){% else %}rgba(229, 57, 53, 0.12){% endif %}; display: flex; align-items: center; justify-content: center;">
                            <i class="fas {% if transaction.transaction_type == 'income' %}fa-arrow-up{% else %}fa-arrow-down{% endif %}" style="color: {% if transaction.transaction_type == 'income' %}var(--md-success){% else %}var(--md-error){% endif %};"></i>
                        </div>
                        <div class="md-list-item-text" style="flex: 1;">
                            <div class="md-list-item-primary" style="font-weight: 500;">
                                {{ transaction.description }}
                            </div>
                            <div class="md-list-item-secondary">
                                {{ transaction.transaction_date.strftime('%B %d, %Y') }}
                                {% if transaction.budget_category %}
                                    â€¢ <span class="md-chip md-chip-primary" style="padding: 2px 8px; font-size: 12px;">{{ transaction.budget_category.name }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div style="font-size: 18px; font-weight: 500; color: {% if transaction.transaction_type == 'income' %}var(--md-success){% else %}var(--md-error){% endif %};">
                            {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}{{ format_currency(transaction.amount) }}
                        </div>
                    </li>
                    <div class="md-divider" style="margin: 0;"></div>
                    {% endfor %}
                </ul>
            {% else %}
                <div style="padding: 48px 24px; text-align: center;">
                    <i class="fas fa-receipt" style="font-size: 48px; color: var(--md-on-surface-variant); opacity: 0.3; margin-bottom: 16px;"></i>
                    <p style="color: var(--md-on-surface-variant); margin: 0 0 16px 0;">No transactions yet</p>
                    <a href="/transactions" class="md-btn md-btn-filled">Add Your First Transaction</a>
                </div>
            {% endif %}
        </div>
    </div>

<script>
// Material Design Color Palette
const mdColors = {
    primary: '#1E88E5',
    secondary: '#26A69A',
    success: '#43A047',
    warning: '#FB8C00',
    error: '#E53935',
    info: '#039BE5'
};

const chartColors = [
    mdColors.primary,
    mdColors.secondary,
    mdColors.success,
    mdColors.warning,
    mdColors.error,
    mdColors.info,
    '#7E57C2',
    '#EF5350',
    '#66BB6A',
    '#29B6F6'
];

// Load real chart data
fetch('/api/dashboard-data')
    .then(response => response.json())
    .then(data => {
        const ctx1 = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: data.labels.length > 0 ? data.labels : ['No Data Available'],
                datasets: [{
                    data: data.data.length > 0 ? data.data : [1],
                    backgroundColor: data.data.length > 0 ? chartColors : ['#EEEEEE'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                family: 'Roboto',
                                size: 12
                            },
                            padding: 16,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading category chart:', error);
        // Fallback chart
        const ctx1 = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['No Data Available'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#EEEEEE'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    });

fetch('/api/monthly-trend')
    .then(response => response.json())
    .then(data => {
        const ctx2 = document.getElementById('trendChart').getContext('2d');
        new Chart(ctx2, {
            type: 'line',
            data: {
                labels: data.map(d => d.month),
                datasets: [{
                    label: 'Monthly Expenses',
                    data: data.map(d => d.amount),
                    borderColor: mdColors.primary,
                    backgroundColor: 'rgba(30, 136, 229, 0.08)',
                    tension: 0.4,
                    borderWidth: 3,
                    fill: true,
                    pointBackgroundColor: mdColors.primary,
                    pointBorderColor: '#FFFFFF',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                family: 'Roboto'
                            },
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                family: 'Roboto'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            family: 'Roboto'
                        },
                        bodyFont: {
                            family: 'Roboto'
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading trend chart:', error);
        // Fallback chart
        const ctx2 = document.getElementById('trendChart').getContext('2d');
        new Chart(ctx2, {
            type: 'line',
            data: {
                labels: ['No Data'],
                datasets: [{
                    label: 'No Data Available',
                    data: [0],
                    borderColor: '#EEEEEE',
                    backgroundColor: 'rgba(238, 238, 238, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    });
</script>
{% endblock %}