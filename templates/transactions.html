{% extends "base.html" %}

{% block title %}Transactions - Personal Finance Tracker{% endblock %}

{% block content %}

<!-- Page Header -->
<div style="display: flex; justify-content: space-between; align-items: center; padding: 32px 0 24px 0;">
    <h1 style="font-size: 32px; font-weight: 400; margin: 0; color: var(--md-on-surface); display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-list"></i>
        Transactions
    </h1>
    <button class="md-btn md-btn-filled" onclick="openTransactionModal()">
        <i class="fas fa-plus"></i>
        Add Transaction
    </button>
</div>

<!-- Filters -->
<div class="md-card" style="margin-bottom: 24px;">
    <div class="md-card-body">
        <form method="GET" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
            <div class="md-text-field">
                <select name="category" id="filterCategory">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if filters.category == category.id|string %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
                <label for="filterCategory">Category</label>
            </div>

            <div class="md-text-field">
                <select name="type" id="filterType">
                    <option value="">All Types</option>
                    <option value="income" {% if filters.type == 'income' %}selected{% endif %}>Income</option>
                    <option value="expense" {% if filters.type == 'expense' %}selected{% endif %}>Expense</option>
                </select>
                <label for="filterType">Type</label>
            </div>

            <div class="md-text-field">
                <input type="text" name="search" id="filterSearch" value="{{ filters.search or '' }}" placeholder=" ">
                <label for="filterSearch">Search</label>
            </div>

            <button type="submit" class="md-btn md-btn-outlined" style="height: 48px;">
                <i class="fas fa-filter"></i>
                Filter
            </button>
        </form>
    </div>
</div>

<!-- Summary -->
{% if page_summary %}
<div class="md-grid md-grid-cols-3" style="margin-bottom: 24px;">
    <div class="md-card" style="background: linear-gradient(135deg, var(--md-success) 0%, #2E7D32 100%); color: white;">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; opacity: 0.9; font-weight: 400;">Total Income</h6>
            <div style="font-size: 32px; font-weight: 400;">{{ format_currency(page_summary.total_income) }}</div>
        </div>
    </div>
    <div class="md-card" style="background: linear-gradient(135deg, var(--md-error) 0%, #C62828 100%); color: white;">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; opacity: 0.9; font-weight: 400;">Total Expenses</h6>
            <div style="font-size: 32px; font-weight: 400;">{{ format_currency(page_summary.total_expenses) }}</div>
        </div>
    </div>
    <div class="md-card md-card-elevated">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; color: var(--md-on-surface-variant); font-weight: 400;">Net Amount</h6>
            <div style="font-size: 32px; font-weight: 500; color: {% if page_summary.net_amount >= 0 %}var(--md-success){% else %}var(--md-error){% endif %};">{{ format_currency(page_summary.net_amount) }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Transactions List -->
<div class="md-card">
    <div class="md-card-header">
        <h5 class="md-card-title">All Transactions</h5>
    </div>
    <div class="md-card-body" style="padding: 0;">
        {% if transactions.items %}
            <ul class="md-list">
                {% for transaction in transactions.items %}
                <li class="md-list-item" data-transaction-id="{{ transaction.id }}">
                    <!-- Icon -->
                    <div class="md-list-item-icon" style="width: 48px; height: 48px; border-radius: 50%; background-color: {% if transaction.transaction_type == 'income' %}rgba(67, 160, 71, 0.12){% else %}rgba(229, 57, 53, 0.12){% endif %}; display: flex; align-items: center; justify-content: center;">
                        <i class="fas {% if transaction.transaction_type == 'income' %}fa-arrow-up{% else %}fa-arrow-down{% endif %}" style="color: {% if transaction.transaction_type == 'income' %}var(--md-success){% else %}var(--md-error){% endif %}; font-size: 20px;"></i>
                    </div>

                    <!-- Transaction Details -->
                    <div class="md-list-item-text" style="flex: 1;">
                        <div class="md-list-item-primary" style="font-weight: 500; display: flex; align-items: center; gap: 8px;">
                            {{ transaction.description }}
                            {% if transaction.budget_category %}
                                <span class="md-chip md-chip-primary" style="padding: 2px 8px; font-size: 11px;">{{ transaction.budget_category.name }}</span>
                            {% endif %}
                        </div>
                        <div class="md-list-item-secondary" style="display: flex; align-items: center; gap: 12px;">
                            <span><i class="fas fa-calendar" style="margin-right: 4px;"></i>{{ transaction.transaction_date.strftime('%b %d, %Y') }}</span>
                            {% if transaction.payee %}
                                <span><i class="fas fa-user" style="margin-right: 4px;"></i>{{ transaction.payee }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Amount -->
                    <div style="text-align: right; margin-right: 16px;">
                        <div style="font-size: 18px; font-weight: 500; color: {% if transaction.transaction_type == 'income' %}var(--md-success){% else %}var(--md-error){% endif %};">
                            {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}{{ format_currency(transaction.amount) }}
                        </div>
                        <div style="font-size: 12px; color: var(--md-on-surface-variant);">
                            {{ transaction.account|default('checking')|title }}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: 4px;">
                        <button class="md-btn-icon" onclick="editTransaction({{ transaction.id }})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="md-btn-icon" onclick="deleteTransaction({{ transaction.id }})" title="Delete" style="color: var(--md-error);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </li>
                <div class="md-divider" style="margin: 0;"></div>
                {% endfor %}
            </ul>
        {% else %}
            <div style="padding: 64px 24px; text-align: center;">
                <i class="fas fa-receipt" style="font-size: 64px; color: var(--md-on-surface-variant); opacity: 0.3; margin-bottom: 24px;"></i>
                <p style="color: var(--md-on-surface-variant); margin: 0 0 24px 0; font-size: 18px;">No transactions found</p>
                <button class="md-btn md-btn-filled" onclick="openTransactionModal()">
                    <i class="fas fa-plus"></i>
                    Add Your First Transaction
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if transactions.pages > 1 %}
<div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px;">
    {% if transactions.has_prev %}
        <a href="{{ url_for('main.transactions', page=transactions.prev_num, **filters) }}" class="md-btn md-btn-outlined">
            <i class="fas fa-chevron-left"></i>
            Previous
        </a>
    {% endif %}

    <div style="display: flex; gap: 4px;">
        {% for page_num in transactions.iter_pages() %}
            {% if page_num %}
                {% if page_num != transactions.page %}
                    <a href="{{ url_for('main.transactions', page=page_num, **filters) }}" class="md-btn-icon" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        {{ page_num }}
                    </a>
                {% else %}
                    <button class="md-btn-icon" style="width: 40px; height: 40px; background-color: var(--md-primary); color: white; display: flex; align-items: center; justify-content: center;">
                        {{ page_num }}
                    </button>
                {% endif %}
            {% else %}
                <span style="padding: 0 8px; color: var(--md-on-surface-variant);">â€¦</span>
            {% endif %}
        {% endfor %}
    </div>

    {% if transactions.has_next %}
        <a href="{{ url_for('main.transactions', page=transactions.next_num, **filters) }}" class="md-btn md-btn-outlined">
            Next
            <i class="fas fa-chevron-right"></i>
        </a>
    {% endif %}
</div>
{% endif %}

<!-- Material Design Modal -->
<div id="addTransactionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; overflow-y: auto;">
    <div class="md-card" style="width: 600px; max-width: 90%; margin: 24px auto;">
        <div class="md-card-header">
            <h5 class="md-card-title" id="modalTitle">Add Transaction</h5>
        </div>
        <div class="md-card-body">
            <form id="transactionForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0 16px;">
                <!-- Transaction Type -->
                <div class="md-text-field" style="grid-column: 1 / -1;">
                    <select name="transaction_type" id="transactionType" required>
                        <option value="">Select type...</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <label for="transactionType">Transaction Type</label>
                </div>

                <!-- Date -->
                <div class="md-text-field">
                    <input type="date" name="transaction_date" id="transactionDate" required>
                    <label for="transactionDate">Date</label>
                </div>

                <!-- Amount -->
                <div class="md-text-field">
                    <input type="number" name="amount" id="transactionAmount" step="0.01" min="0" placeholder=" " required>
                    <label for="transactionAmount">Amount ($)</label>
                </div>

                <!-- Description -->
                <div class="md-text-field" style="grid-column: 1 / -1;">
                    <input type="text" name="description" id="transactionDescription" placeholder=" " required>
                    <label for="transactionDescription">Description</label>
                </div>

                <!-- Category -->
                <div class="md-text-field">
                    <select name="category_id" id="transactionCategory">
                        <option value="">None</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="transactionCategory">Category</label>
                </div>

                <!-- Account -->
                <div class="md-text-field">
                    <select name="account" id="transactionAccount">
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="credit">Credit Card</option>
                        <option value="cash">Cash</option>
                    </select>
                    <label for="transactionAccount">Account</label>
                </div>

                <!-- Payee -->
                <div class="md-text-field" style="grid-column: 1 / -1;">
                    <input type="text" name="payee" id="transactionPayee" placeholder=" ">
                    <label for="transactionPayee">Payee (Optional)</label>
                </div>

                <!-- Tags -->
                <div class="md-text-field" style="grid-column: 1 / -1;">
                    <input type="text" name="tags" id="transactionTags" placeholder=" ">
                    <label for="transactionTags">Tags (Optional)</label>
                    <small style="font-size: 12px; color: var(--md-on-surface-variant); margin-top: 4px;">e.g., work, travel, grocery</small>
                </div>
            </form>
        </div>
        <div class="md-card-actions">
            <button type="button" class="md-btn md-btn-text" onclick="closeTransactionModal()">Cancel</button>
            <button type="button" class="md-btn md-btn-filled" onclick="submitTransaction()">Save Transaction</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let editingTransactionId = null;

// Open modal
function openTransactionModal() {
    editingTransactionId = null;
    document.getElementById('modalTitle').textContent = 'Add Transaction';
    document.getElementById('transactionForm').reset();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('transactionDate').value = today;
    document.getElementById('addTransactionModal').style.display = 'flex';
}

// Close modal
function closeTransactionModal() {
    document.getElementById('addTransactionModal').style.display = 'none';
    document.getElementById('transactionForm').reset();
    editingTransactionId = null;
}

// Close modal when clicking outside
document.getElementById('addTransactionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTransactionModal();
    }
});

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('transactionDate').value = today;
});

async function submitTransaction() {
    const form = document.getElementById('transactionForm');

    // Validate form
    if (!form.checkValidity()) {
        showMaterialSnackbar('Please fill in all required fields', 'error');
        return;
    }

    const formData = new FormData(form);

    const transactionData = {
        transaction_type: formData.get('transaction_type'),
        transaction_date: formData.get('transaction_date'),
        description: formData.get('description'),
        amount: parseFloat(formData.get('amount')),
        category_id: formData.get('category_id') || null,
        payee: formData.get('payee') || '',
        account: formData.get('account') || 'checking',
        tags: formData.get('tags') || ''
    };

    try {
        const url = editingTransactionId ?
            `/api/transactions/${editingTransactionId}` :
            '/api/transactions/';
        const method = editingTransactionId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(transactionData)
        });

        const result = await response.json();

        if (response.ok) {
            closeTransactionModal();
            showMaterialSnackbar(result.message || 'Transaction saved successfully!', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMaterialSnackbar(result.error || 'Failed to save transaction', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Network error. Please try again.', 'error');
    }
}

async function editTransaction(id) {
    try {
        const response = await fetch(`/api/transactions/${id}`);
        const transaction = await response.json();

        if (response.ok) {
            editingTransactionId = id;

            // Populate form
            document.getElementById('transactionType').value = transaction.transaction_type;
            document.getElementById('transactionDate').value = transaction.transaction_date;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionCategory').value = transaction.category ? transaction.category.id : '';
            document.getElementById('transactionPayee').value = transaction.payee || '';
            document.getElementById('transactionAccount').value = transaction.account || 'checking';
            document.getElementById('transactionTags').value = transaction.tags || '';

            // Update modal title
            document.getElementById('modalTitle').textContent = 'Edit Transaction';

            // Show modal
            document.getElementById('addTransactionModal').style.display = 'flex';
        } else {
            showMaterialSnackbar('Failed to load transaction details', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Network error. Please try again.', 'error');
    }
}

async function deleteTransaction(id) {
    if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/transactions/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            showMaterialSnackbar(result.message || 'Transaction deleted successfully!', 'success');

            // Remove the item from the list
            const item = document.querySelector(`li[data-transaction-id="${id}"]`);
            if (item) {
                item.nextElementSibling?.remove(); // Remove divider
                item.remove();
            }

            setTimeout(() => window.location.reload(), 1000);
        } else {
            showMaterialSnackbar(result.error || 'Failed to delete transaction', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Network error. Please try again.', 'error');
    }
}

function showMaterialSnackbar(message, type = 'info') {
    const snackbar = document.createElement('div');
    snackbar.className = 'md-snackbar show';

    const colors = {
        'success': 'var(--md-success)',
        'error': 'var(--md-error)',
        'warning': 'var(--md-warning)',
        'info': 'var(--md-info)'
    };
    snackbar.style.backgroundColor = colors[type] || colors.info;

    snackbar.innerHTML = `
        <span>${message}</span>
        <button class="md-btn md-btn-text" style="color: white; padding: 8px 16px;" onclick="this.parentElement.remove()">
            Dismiss
        </button>
    `;

    document.body.appendChild(snackbar);

    setTimeout(() => {
        snackbar.style.opacity = '0';
        setTimeout(() => snackbar.parentNode && snackbar.remove(), 300);
    }, 5000);
}
</script>
{% endblock %}