# templates/budget.html """ {% extends "base.html" %} {% block title %}Budget -
Personal Finance Tracker{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-calculator me-2"></i>Budget Management</h2>
  <div class="text-end">
    <small class="text-muted exchange-rate"
      >1 USD = {{ "%.2f"|format(exchange_rate) }} KES</small
    >
  </div>
</div>

<!-- YNAB Principles Banner -->
<div class="alert alert-info mb-4">
  <h6><i class="fas fa-lightbulb me-2"></i>YNAB Principles</h6>
  <div class="row">
    <div class="col-md-3">
      <small
        ><strong>1. Give Every Shilling a Job</strong><br />Allocate all income
        to categories</small
      >
    </div>
    <div class="col-md-3">
      <small
        ><strong>2. Embrace True Expenses</strong><br />Budget for irregular
        costs</small
      >
    </div>
    <div class="col-md-3">
      <small
        ><strong>3. Roll with the Punches</strong><br />Reallocate when
        overspending</small
      >
    </div>
    <div class="col-md-3">
      <small
        ><strong>4. Live on Last Month's Income</strong><br />Build a
        buffer</small
      >
    </div>
  </div>
</div>

<!-- Budget Allocation Summary -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h6 class="text-muted">Available to Budget</h6>
        <div class="h4" id="available-to-budget">0 KES</div>
        <small class="text-muted">Unallocated income</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h6 class="text-muted">Total Budgeted</h6>
        <div class="h4" id="total-budgeted">
          {{
          "{:,.0f}"|format(categories|selectattr('is_active')|map(attribute='budgeted_kes')|sum)
          }} KES
        </div>
        <small class="text-muted">This month</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h6 class="text-muted">Total Spent</h6>
        <div class="h4" id="total-spent">0 KES</div>
        <small class="text-muted">This month</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body text-center">
        <h6 class="text-muted">Remaining</h6>
        <div class="h4" id="total-remaining">0 KES</div>
        <small class="text-muted">Available to spend</small>
      </div>
    </div>
  </div>
</div>

<!-- Budget Categories -->
<div class="row">
  <!-- Income Categories -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Income</h5>
      </div>
      <div class="card-body">
        <div class="row">
          {% for category in categories if category.category_type == 'income'
          and category.is_active %}
          <div class="col-md-6 mb-3">
            <div
              class="card category-card"
              data-category-id="{{ category.id }}"
              data-budgeted="{{ category.budgeted_kes }}"
              data-spent="0"
            >
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="mb-0">{{ category.name }}</h6>
                  <span class="badge bg-success"
                    >{{ "{:,.0f}"|format(category.budgeted_kes) }} KES</span
                  >
                </div>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control budget-input"
                    data-category-id="{{ category.id }}"
                    data-currency="KES"
                    value="{{ category.budgeted_kes }}"
                    step="1000"
                  />
                  <span class="input-group-text">KES</span>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Fixed Expenses -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fas fa-home me-2"></i>Fixed Expenses</h5>
      </div>
      <div class="card-body">
        <div class="row">
          {% for category in categories if category.category_type == 'fixed' and
          category.is_active %}
          <div class="col-md-6 mb-3">
            <div
              class="card category-card"
              data-category-id="{{ category.id }}"
            >
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="mb-0">{{ category.name }}</h6>
                  <span class="badge bg-danger"
                    >{{ "{:,.0f}"|format(category.budgeted_kes) }} KES</span
                  >
                </div>
                <div class="progress mb-2" style="height: 6px">
                  <div class="progress-bar bg-danger" style="width: 0%"></div>
                </div>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control budget-input"
                    data-category-id="{{ category.id }}"
                    data-currency="KES"
                    value="{{ category.budgeted_kes }}"
                    step="1000"
                  />
                  <span class="input-group-text">KES</span>
                </div>
                <small class="text-muted">Spent: 0 KES</small>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- True Expenses -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header bg-warning text-white">
        <h5 class="mb-0">
          <i class="fas fa-calendar-alt me-2"></i>True Expenses
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          {% for category in categories if category.category_type ==
          'true_expense' and category.is_active %}
          <div class="col-md-6 mb-3">
            <div
              class="card category-card"
              data-category-id="{{ category.id }}"
            >
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="mb-0">{{ category.name }}</h6>
                  <span class="badge bg-warning"
                    >{{ "{:,.0f}"|format(category.budgeted_kes) }} KES</span
                  >
                </div>
                <div class="progress mb-2" style="height: 6px">
                  <div class="progress-bar bg-warning" style="width: 0%"></div>
                </div>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control budget-input"
                    data-category-id="{{ category.id }}"
                    data-currency="KES"
                    value="{{ category.budgeted_kes }}"
                    step="1000"
                  />
                  <span class="input-group-text">KES</span>
                </div>
                <small class="text-muted">Saved: 0 KES</small>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Variable Expenses -->
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">
          <i class="fas fa-shopping-cart me-2"></i>Variable Expenses
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          {% for category in categories if category.category_type == 'variable'
          and category.is_active %}
          <div class="col-md-6 mb-3">
            <div
              class="card category-card"
              data-category-id="{{ category.id }}"
            >
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="mb-0">{{ category.name }}</h6>
                  <span class="badge bg-info"
                    >{{ "{:,.0f}"|format(category.budgeted_kes) }} KES</span
                  >
                </div>
                <div class="progress mb-2" style="height: 6px">
                  <div class="progress-bar bg-info" style="width: 0%"></div>
                </div>
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    class="form-control budget-input"
                    data-category-id="{{ category.id }}"
                    data-currency="KES"
                    value="{{ category.budgeted_kes }}"
                    step="100"
                  />
                  <span class="input-group-text">KES</span>
                </div>
                <small class="text-muted"
                  >Remaining: {{ "{:,.0f}"|format(category.budgeted_kes) }}
                  KES</small
                >
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Financial Milestones -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
          <i class="fas fa-trophy me-2"></i>Financial Milestones
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          {% for milestone in milestones %}
          <div class="col-md-6 mb-3">
            <div
              class="card milestone-card {% if milestone.is_completed %}completed{% endif %}"
              id="milestone-{{ milestone.id }}"
              data-target-amount="{{ milestone.target_amount_kes }}"
            >
              <div class="card-body">
                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <h6 class="mb-0">{{ milestone.name }}</h6>
                  <span class="milestone-status">
                    {% if milestone.is_completed %}
                    <i class="fas fa-check-circle text-success"></i> Completed
                    {% else %} <i class="fas fa-target text-primary"></i> In
                    Progress {% endif %}
                  </span>
                </div>

                {% set progress_percent = (milestone.current_amount_kes /
                milestone.target_amount_kes * 100) if
                milestone.target_amount_kes > 0 else 0 %}

                <div class="progress mb-2" style="height: 8px">
                  <div
                    class="progress-bar bg-primary"
                    style="width: {{ [progress_percent, 100]|min }}%"
                    aria-valuenow="{{ progress_percent }}"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>

                <div
                  class="d-flex justify-content-between align-items-center mb-2"
                >
                  <small class="progress-text">
                    {{ "{:,.0f}"|format(milestone.current_amount_kes) }} / {{
                    "{:,.0f}"|format(milestone.target_amount_kes) }} KES ({{
                    "%.1f"|format(progress_percent) }}%)
                  </small>
                  <small class="text-muted"
                    >Priority: {{ milestone.priority }}</small
                  >
                </div>

                <div class="input-group input-group-sm">
                  <span class="input-group-text">Progress</span>
                  <input
                    type="number"
                    class="form-control milestone-input"
                    data-milestone-id="{{ milestone.id }}"
                    value="{{ milestone.current_amount_kes }}"
                    step="1000"
                    max="{{ milestone.target_amount_kes }}"
                  />
                  <span class="input-group-text">KES</span>
                </div>

                {% if milestone.target_date %}
                <small class="text-muted mt-2 d-block">
                  <i class="fas fa-calendar me-1"></i>Target: {{
                  milestone.target_date.strftime('%Y-%m-%d') }}
                </small>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Additional budget-specific JavaScript
  document.addEventListener("DOMContentLoaded", function () {
    updateBudgetSummary();

    // Update summary when budget inputs change
    document.querySelectorAll(".budget-input").forEach((input) => {
      input.addEventListener("change", updateBudgetSummary);
    });
  });

  function updateBudgetSummary() {
    const incomeTotal = Array.from(
      document.querySelectorAll('.budget-input[data-currency="KES"]')
    )
      .filter((input) =>
        input.closest(".card-header")?.textContent.includes("Income")
      )
      .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);

    const budgetedTotal = Array.from(
      document.querySelectorAll('.budget-input[data-currency="KES"]')
    ).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);

    const availableToBudget = incomeTotal - budgetedTotal;

    document.getElementById("available-to-budget").textContent =
      new Intl.NumberFormat("en-KE").format(availableToBudget) + " KES";
    document.getElementById("total-budgeted").textContent =
      new Intl.NumberFormat("en-KE").format(budgetedTotal) + " KES";

    // Color code available to budget
    const availableElement = document.getElementById("available-to-budget");
    availableElement.className =
      availableToBudget === 0
        ? "h4 text-success"
        : availableToBudget > 0
        ? "h4 text-warning"
        : "h4 text-danger";
  }
</script>
{% endblock %} """ # templates/transactions.html """ {% extends "base.html" %}
{% block title %}Transactions - Personal Finance Tracker{% endblock %} {% block
content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-list me-2"></i>Transactions</h2>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" onclick="showModal('transactionModal')">
      <i class="fas fa-plus me-2"></i>Add Transaction
    </button>
    <button class="btn btn-outline-secondary" onclick="exportTransactions()">
      <i class="fas fa-download me-2"></i>Export
    </button>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form id="filterForm" class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Date From</label>
        <input type="date" class="form-control" name="date_from" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Date To</label>
        <input type="date" class="form-control" name="date_to" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Category</label>
        <select class="form-select" name="category_id">
          <option value="">All Categories</option>
          {% for category in categories %}
          <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Account</label>
        <select class="form-select" name="account_id">
          <option value="">All Accounts</option>
          {% for account in accounts %}
          <option value="{{ account.id }}">{{ account.name }}</option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>
</div>

<!-- Transactions Table -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Account</th>
            <th>Category</th>
            <th>Amount (KES)</th>
            <th>Amount (USD)</th>
            <th>Rate</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for transaction in transactions.items %}
          <tr>
            <td>{{ transaction.transaction_date.strftime('%Y-%m-%d') }}</td>
            <td>{{ transaction.description }}</td>
            <td>
              <span class="badge bg-secondary"
                >{{ transaction.account.name }}</span
              >
            </td>
            <td>
              {% if transaction.category %}
              <span class="badge bg-primary"
                >{{ transaction.category.name }}</span
              >
              {% else %}
              <span class="text-muted">Uncategorized</span>
              {% endif %}
            </td>
            <td
              class="{% if transaction.amount_kes >= 0 %}text-success{% else %}text-danger{% endif %}"
            >
              {{ "{:+,.0f}"|format(transaction.amount_kes) }}
            </td>
            <td
              class="{% if transaction.amount_usd >= 0 %}text-success{% else %}text-danger{% endif %}"
            >
              {{ "{:+,.2f}"|format(transaction.amount_usd) }}
            </td>
            <td class="text-muted">
              {{ "%.2f"|format(transaction.exchange_rate) }}
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button
                  class="btn btn-outline-primary btn-sm"
                  onclick="editTransaction({{ transaction.id }})"
                >
                  <i class="fas fa-edit"></i>
                </button>
                <button
                  class="btn btn-outline-danger btn-sm"
                  onclick="deleteTransaction({{ transaction.id }})"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted py-5">
              No transactions found.
              <button
                class="btn btn-link"
                onclick="showModal('transactionModal')"
              >
                Add your first transaction
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
{% if transactions.pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% if transactions.has_prev %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('transactions', page=transactions.prev_num) }}"
        >Previous</a
      >
    </li>
    {% endif %} {% for page_num in transactions.iter_pages() %} {% if page_num
    %} {% if page_num != transactions.page %}
    <li class="page-item">
      <a class="page-link" href="{{ url_for('transactions', page=page_num) }}"
        >{{ page_num }}</a
      >
    </li>
    {% else %}
    <li class="page-item active">
      <span class="page-link">{{ page_num }}</span>
    </li>
    {% endif %} {% else %}
    <li class="page-item disabled">
      <span class="page-link">…</span>
    </li>
    {% endif %} {% endfor %} {% if transactions.has_next %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('transactions', page=transactions.next_num) }}"
        >Next</a
      >
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %}

<!-- Add Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Transaction</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="transactionForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Type</label>
              <select name="type" class="form-select" required>
                <option value="income">Income</option>
                <option value="expense" selected>Expense</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Date</label>
              <input
                type="date"
                name="date"
                class="form-control"
                value="{{ datetime.now().strftime('%Y-%m-%d') }}"
                required
              />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Currency</label>
              <select name="currency" class="form-select currency-select">
                <option value="KES" selected>KES</option>
                <option value="USD">USD</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <input
              type="text"
              name="description"
              class="form-control"
              placeholder="What was this transaction for?"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Amount</label>
            <div class="input-group">
              <input
                type="number"
                name="amount"
                class="form-control amount-input"
                step="0.01"
                placeholder="0.00"
                required
              />
              <span class="input-group-text currency-symbol">KES</span>
            </div>
            <div class="form-text converted-amount"></div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Account</label>
              <select name="account_id" class="form-select" required>
                {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Category</label>
              <select name="category_id" class="form-select">
                <option value="">Select Category</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="alert alert-info">
            <small>
              <i class="fas fa-info-circle me-1"></i>
              Exchange rate: 1 USD = {{ "%.2f"|format(exchange_rate) }} KES
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Add Transaction</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Update currency display
  document.querySelector('.currency-select').addEventListener('change', function(e) {
      const currency = e.target.value;
      document.querySelector('.currency-symbol').textContent = currency;
      updateConversion();
  });

  // Update amount conversion
  document.querySelector('.amount-input').addEventListener('input', updateConversion);

  function updateConversion() {
      const amount = parseFloat(document.querySelector('.amount-input').value) || 0;
      const currency = document.querySelector('.currency-select').value;
      const rate = {{ exchange_rate }};

      if (amount > 0) {
          let convertedAmount, convertedCurrency;

          if (currency === 'KES') {
              convertedAmount = (amount / rate).toFixed(2);
              convertedCurrency = 'USD';
          } else {
              convertedAmount = (amount * rate).toFixed(0);
              convertedCurrency = 'KES';
          }

          document.querySelector('.converted-amount').textContent =
              `≈ ${new Intl.NumberFormat().format(convertedAmount)} ${convertedCurrency}`;
      } else {
          document.querySelector('.converted-amount').textContent = '';
      }
  }

  function editTransaction(transactionId) {
      // Implementation for editing transactions
      alert('Edit functionality coming soon!');
  }

  function deleteTransaction(transactionId) {
      if (confirm('Are you sure you want to delete this transaction?')) {
          // Implementation for deleting transactions
          alert('Delete functionality coming soon!');
      }
  }

  function exportTransactions() {
      // Export transactions as CSV
      window.location.href = '/api/export_transactions';
  }
</script>
{% endblock %} """
