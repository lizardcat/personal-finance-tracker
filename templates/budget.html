{% extends "base.html" %}

{% block title %}Budget - Personal Finance Tracker{% endblock %}

{% block content %}

<!-- Page Header -->
<div style="display: flex; justify-content: space-between; align-items: center; padding: 32px 0 24px 0;">
    <div>
        <h1 style="font-size: 32px; font-weight: 400; margin: 0; color: var(--md-on-surface); display: flex; align-items: center; gap: 12px;">
            <i class="fas fa-calculator"></i>
            Budget Management
        </h1>
        <p style="color: var(--md-on-surface-variant); margin: 8px 0 0 0;">Exchange Rate: 1 USD = {{ "%.2f"|format(exchange_rate) }} KES</p>
    </div>
    <div style="display: flex; gap: 12px;">
        <button class="md-btn md-btn-outlined" onclick="openTransferModal()">
            <i class="fas fa-exchange-alt"></i>
            Transfer Budget
        </button>
        <button class="md-btn md-btn-filled" onclick="openCategoryModal()">
            <i class="fas fa-plus"></i>
            Add Category
        </button>
    </div>
</div>

<!-- YNAB Principles Banner -->
<div class="md-card" style="background: linear-gradient(135deg, var(--md-info) 0%, var(--md-primary) 100%); color: white; margin-bottom: 24px;">
    <div class="md-card-body">
        <h5 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-lightbulb"></i>
            YNAB Principles
        </h5>
        <div class="md-grid md-grid-cols-4">
            <div>
                <strong style="display: block; margin-bottom: 4px;">1. Give Every Shilling a Job</strong>
                <small style="opacity: 0.9;">Allocate all income to categories</small>
            </div>
            <div>
                <strong style="display: block; margin-bottom: 4px;">2. Embrace True Expenses</strong>
                <small style="opacity: 0.9;">Budget for irregular costs</small>
            </div>
            <div>
                <strong style="display: block; margin-bottom: 4px;">3. Roll with the Punches</strong>
                <small style="opacity: 0.9;">Reallocate when overspending</small>
            </div>
            <div>
                <strong style="display: block; margin-bottom: 4px;">4. Live on Last Month's Income</strong>
                <small style="opacity: 0.9;">Build a buffer</small>
            </div>
        </div>
    </div>
</div>

<!-- Budget Summary -->
<div class="md-grid md-grid-cols-3" style="margin-bottom: 24px;">
    <div class="md-card" style="background: linear-gradient(135deg, var(--md-success) 0%, #2E7D32 100%); color: white;">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; opacity: 0.9; font-weight: 400;">Total Income</h6>
            <div style="font-size: 32px; font-weight: 400; margin-bottom: 4px;">{{ format_currency(income_total) }}</div>
            <small style="opacity: 0.8;">Monthly income</small>
        </div>
    </div>
    <div class="md-card" style="background: linear-gradient(135deg, var(--md-error) 0%, #C62828 100%); color: white;">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; opacity: 0.9; font-weight: 400;">Total Expenses</h6>
            <div style="font-size: 32px; font-weight: 400; margin-bottom: 4px;">{{ format_currency(expense_total) }}</div>
            <small style="opacity: 0.8;">Monthly expenses</small>
        </div>
    </div>
    <div class="md-card md-card-elevated">
        <div class="md-card-body" style="text-align: center;">
            <h6 style="margin: 0 0 8px 0; color: var(--md-on-surface-variant); font-weight: 400;">Available</h6>
            <div style="font-size: 32px; font-weight: 500; margin-bottom: 4px; color: {% if income_total - expense_total >= 0 %}var(--md-success){% else %}var(--md-error){% endif %};">{{ format_currency(income_total - expense_total) }}</div>
            <small style="color: var(--md-on-surface-variant);">Remaining budget</small>
        </div>
    </div>
</div>

<!-- Budget Categories -->
<!-- Income Categories -->
<div class="md-card" style="margin-bottom: 24px;">
    <div class="md-card-header" style="background: linear-gradient(135deg, var(--md-success) 0%, #2E7D32 100%); color: white; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-plus-circle"></i>
        <h5 class="md-card-title" style="color: white;">Income Sources</h5>
    </div>
    <div class="md-card-body">
        {% set income_categories = categories|selectattr('category_type', 'equalto', 'income')|list %}
        {% if income_categories %}
            <div class="md-grid md-grid-cols-2">
                {% for category in income_categories %}
                <div class="md-card md-card-elevated">
                    <div class="md-card-body">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h6 style="margin: 0; font-weight: 500;">{{ category.name }}</h6>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="md-chip md-chip-success">{{ format_currency(category.allocated_amount) }}</span>
                                <button class="md-btn-icon" onclick="editCategory({{ category.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="md-btn-icon" onclick="deleteCategory({{ category.id }})" title="Delete" style="color: var(--md-error);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: var(--md-on-surface-variant); text-align: center; padding: 32px 0;">No income categories defined yet.</p>
        {% endif %}
    </div>
</div>

<!-- Expense Categories -->
<div class="md-card" style="margin-bottom: 24px;">
    <div class="md-card-header" style="background: linear-gradient(135deg, var(--md-error) 0%, #C62828 100%); color: white; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-minus-circle"></i>
        <h5 class="md-card-title" style="color: white;">Expense Categories</h5>
    </div>
    <div class="md-card-body">
        {% set expense_categories = categories|selectattr('category_type', 'equalto', 'expense')|list %}
        {% if expense_categories %}
            <div class="md-grid md-grid-cols-2">
                {% for category in expense_categories %}
                <div class="md-card md-card-elevated">
                    <div class="md-card-body">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h6 style="margin: 0; font-weight: 500;">{{ category.name }}</h6>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="md-chip md-chip-error">{{ format_currency(category.allocated_amount) }}</span>
                                <button class="md-btn-icon" onclick="editCategory({{ category.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="md-btn-icon" onclick="deleteCategory({{ category.id }})" title="Delete" style="color: var(--md-error);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Material Progress Bar -->
                        <div class="md-progress-linear" style="margin-bottom: 8px;">
                            {% set spent_amount = category.allocated_amount - category.available_amount %}
                            {% set progress = (spent_amount / category.allocated_amount * 100) if category.allocated_amount > 0 else 0 %}
                            <div class="md-progress-bar" style="width: {{ [progress, 100]|min }}%; background-color: {% if progress >= 90 %}var(--md-error){% elif progress >= 70 %}var(--md-warning){% else %}var(--md-primary){% endif %};"></div>
                        </div>
                        <small style="color: var(--md-on-surface-variant);">
                            Spent: {{ format_currency(spent_amount) }} / Available: {{ format_currency(category.available_amount) }}
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: var(--md-on-surface-variant); text-align: center; padding: 32px 0;">No expense categories defined yet.</p>
        {% endif %}
    </div>
</div>

<!-- Savings Categories -->
<div class="md-card" style="margin-bottom: 24px;">
    <div class="md-card-header" style="background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-primary-dark) 100%); color: white; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-piggy-bank"></i>
        <h5 class="md-card-title" style="color: white;">Savings Goals</h5>
    </div>
    <div class="md-card-body">
        {% set saving_categories = categories|selectattr('category_type', 'equalto', 'saving')|list %}
        {% if saving_categories %}
            <div class="md-grid md-grid-cols-2">
                {% for category in saving_categories %}
                <div class="md-card md-card-elevated">
                    <div class="md-card-body">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h6 style="margin: 0; font-weight: 500;">{{ category.name }}</h6>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="md-chip md-chip-primary">{{ format_currency(category.allocated_amount) }}</span>
                                <button class="md-btn-icon" onclick="editCategory({{ category.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="md-btn-icon" onclick="deleteCategory({{ category.id }})" title="Delete" style="color: var(--md-error);">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: var(--md-on-surface-variant); text-align: center; padding: 32px 0;">No savings goals defined yet.</p>
        {% endif %}
    </div>
</div>

<!-- Material Design Modal Overlay -->
<div id="categoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="md-card" style="width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; margin: 24px;">
        <div class="md-card-header">
            <h5 class="md-card-title" id="modalTitle">Add Budget Category</h5>
        </div>
        <div class="md-card-body">
            <form id="categoryForm">
                <!-- Category Name -->
                <div class="md-text-field">
                    <input type="text" name="name" id="categoryName" placeholder=" " required>
                    <label for="categoryName">Category Name</label>
                </div>

                <!-- Category Type -->
                <div class="md-text-field">
                    <select name="category_type" id="categoryType" required>
                        <option value="">Select type...</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                        <option value="saving">Savings Goal</option>
                    </select>
                    <label for="categoryType">Category Type</label>
                </div>

                <!-- Allocated Amount -->
                <div class="md-text-field">
                    <input type="number" name="allocated_amount" id="allocatedAmount" step="0.01" min="0" placeholder=" " required>
                    <label for="allocatedAmount">Allocated Amount ($)</label>
                </div>

                <!-- Color -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 12px; color: var(--md-on-surface-variant); margin-bottom: 8px;">Category Color</label>
                    <input type="color" name="color" id="categoryColor" value="#1E88E5" style="width: 100%; height: 48px; border-radius: var(--md-radius-sm); border: 1px solid var(--md-on-surface-variant); cursor: pointer;">
                </div>
            </form>
        </div>
        <div class="md-card-actions">
            <button type="button" class="md-btn md-btn-text" onclick="closeCategoryModal()">Cancel</button>
            <button type="button" class="md-btn md-btn-filled" onclick="submitCategory()">Save Category</button>
        </div>
    </div>
</div>

<!-- Budget Transfer Modal -->
<div id="transferModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="md-card" style="width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; margin: 24px;">
        <div class="md-card-header">
            <h5 class="md-card-title">Transfer Budget Between Categories</h5>
        </div>
        <div class="md-card-body">
            <p style="color: var(--md-on-surface-variant); margin-bottom: 24px; font-size: 14px;">
                Move budget allocation from one category to another. This is useful when you need to reallocate funds (YNAB Principle #3: Roll with the Punches).
            </p>

            <form id="transferForm">
                <!-- From Category -->
                <div class="md-text-field">
                    <select id="fromCategory" required>
                        <option value="">Select source category...</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" data-available="{{ category.available_amount }}">
                            {{ category.name }} - Available: {{ format_currency(category.available_amount) }}
                        </option>
                        {% endfor %}
                    </select>
                    <label for="fromCategory">From Category</label>
                </div>

                <!-- Transfer Amount -->
                <div class="md-text-field">
                    <input type="number" id="transferAmount" step="0.01" min="0.01" placeholder=" " required>
                    <label for="transferAmount">Transfer Amount ($)</label>
                </div>
                <p id="availableAmount" style="font-size: 12px; color: var(--md-on-surface-variant); margin-top: -12px; margin-bottom: 16px;">
                    Select a category to see available amount
                </p>

                <!-- To Category -->
                <div class="md-text-field">
                    <select id="toCategory" required>
                        <option value="">Select destination category...</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <label for="toCategory">To Category</label>
                </div>
            </form>
        </div>
        <div class="md-card-actions">
            <button type="button" class="md-btn md-btn-text" onclick="closeTransferModal()">Cancel</button>
            <button type="button" class="md-btn md-btn-filled" onclick="submitTransfer()">Transfer Budget</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let editingCategoryId = null;

// Open modal function
function openCategoryModal() {
    editingCategoryId = null;
    document.getElementById('modalTitle').textContent = 'Add Budget Category';
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryColor').value = '#1E88E5';
    document.getElementById('categoryModal').style.display = 'flex';
}

// Close modal function
function closeCategoryModal() {
    document.getElementById('categoryModal').style.display = 'none';
    document.getElementById('categoryForm').reset();
    editingCategoryId = null;
}

// Close modal when clicking outside
document.getElementById('categoryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCategoryModal();
    }
});

async function submitCategory() {
    const form = document.getElementById('categoryForm');

    // Validate form
    if (!form.checkValidity()) {
        showMaterialSnackbar('Please fill in all required fields', 'error');
        return;
    }

    const formData = new FormData(form);

    const categoryData = {
        name: formData.get('name'),
        category_type: formData.get('category_type'),
        allocated_amount: parseFloat(formData.get('allocated_amount')),
        color: formData.get('color')
    };

    try {
        const url = editingCategoryId ?
            `/api/budget/categories/${editingCategoryId}` :
            '/api/budget/categories';
        const method = editingCategoryId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(categoryData)
        });

        const result = await response.json();

        if (response.ok) {
            // Close modal
            closeCategoryModal();

            // Show success message
            showMaterialSnackbar(result.message || 'Category saved successfully!', 'success');

            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMaterialSnackbar(result.error || 'Failed to save category', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Network error. Please try again.', 'error');
    }
}

async function editCategory(id) {
    try {
        const response = await fetch(`/api/budget/categories`);
        const data = await response.json();

        if (response.ok) {
            const category = data.categories.find(cat => cat.id === id);
            if (category) {
                editingCategoryId = id;

                // Populate form
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryType').value = category.category_type;
                document.getElementById('allocatedAmount').value = category.allocated_amount;
                document.getElementById('categoryColor').value = category.color;

                // Update modal title
                document.getElementById('modalTitle').textContent = 'Edit Budget Category';

                // Show modal
                document.getElementById('categoryModal').style.display = 'flex';
            } else {
                showMaterialSnackbar('Category not found', 'error');
            }
        } else {
            showMaterialSnackbar('Failed to load category details', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Network error. Please try again.', 'error');
    }
}

async function deleteCategory(id) {
    if (!confirm('Are you sure you want to delete this category? This will also remove it from associated transactions.')) {
        return;
    }

    try {
        const response = await fetch(`/api/budget/categories/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            showMaterialSnackbar(result.message || 'Category deleted successfully!', 'success');

            // Reload page to update display
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMaterialSnackbar(result.error || 'Failed to delete category', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showMaterialSnackbar('Network error. Please try again.', 'error');
    }
}

function showMaterialSnackbar(message, type = 'info') {
    // Create Material Design snackbar
    const snackbar = document.createElement('div');
    snackbar.className = 'md-snackbar show';

    // Set color based on type
    const colors = {
        'success': 'var(--md-success)',
        'error': 'var(--md-error)',
        'warning': 'var(--md-warning)',
        'info': 'var(--md-info)'
    };
    snackbar.style.backgroundColor = colors[type] || colors.info;

    snackbar.innerHTML = `
        <span>${message}</span>
        <button class="md-btn md-btn-text" style="color: white; padding: 8px 16px;" onclick="this.parentElement.remove()">
            Dismiss
        </button>
    `;

    // Add to page
    document.body.appendChild(snackbar);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        snackbar.style.opacity = '0';
        setTimeout(() => {
            if (snackbar.parentNode) {
                snackbar.remove();
            }
        }, 300);
    }, 5000);
}

// Budget Transfer Functions
function openTransferModal() {
    document.getElementById('transferForm').reset();
    document.getElementById('transferModal').style.display = 'flex';
    document.getElementById('availableAmount').textContent = 'Select a category to see available amount';
}

function closeTransferModal() {
    document.getElementById('transferModal').style.display = 'none';
    document.getElementById('transferForm').reset();
}

// Close modal when clicking outside
document.getElementById('transferModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTransferModal();
    }
});

// Update available amount when from category changes
document.getElementById('fromCategory').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    const available = selected.getAttribute('data-available');

    if (available) {
        document.getElementById('availableAmount').textContent = `Available to transfer: $${parseFloat(available).toFixed(2)}`;
        document.getElementById('availableAmount').style.color = parseFloat(available) > 0 ? 'var(--md-success)' : 'var(--md-error)';
    } else {
        document.getElementById('availableAmount').textContent = 'Select a category to see available amount';
        document.getElementById('availableAmount').style.color = 'var(--md-on-surface-variant)';
    }
});

async function submitTransfer() {
    const form = document.getElementById('transferForm');

    // Validate form
    if (!form.checkValidity()) {
        showMaterialSnackbar('Please fill in all required fields', 'error');
        return;
    }

    const fromCategoryId = document.getElementById('fromCategory').value;
    const toCategoryId = document.getElementById('toCategory').value;
    const amount = parseFloat(document.getElementById('transferAmount').value);

    // Validate same category
    if (fromCategoryId === toCategoryId) {
        showMaterialSnackbar('Cannot transfer to the same category', 'error');
        return;
    }

    // Validate available amount
    const fromCategory = document.getElementById('fromCategory').options[document.getElementById('fromCategory').selectedIndex];
    const available = parseFloat(fromCategory.getAttribute('data-available'));

    if (amount > available) {
        showMaterialSnackbar(`Insufficient budget. Available: $${available.toFixed(2)}`, 'error');
        return;
    }

    const transferData = {
        from_category_id: parseInt(fromCategoryId),
        to_category_id: parseInt(toCategoryId),
        amount: amount
    };

    try {
        const response = await fetch('/api/budget/transfer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(transferData)
        });

        const data = await response.json();

        if (response.ok) {
            showMaterialSnackbar(data.message, 'success');
            closeTransferModal();
            // Reload page to show updated budgets
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showMaterialSnackbar(data.error || 'Transfer failed', 'error');
        }
    } catch (error) {
        console.error('Error transferring budget:', error);
        showMaterialSnackbar('An error occurred while transferring budget', 'error');
    }
}
</script>
{% endblock %}